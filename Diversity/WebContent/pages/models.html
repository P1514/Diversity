
<!DOCTYPE html>

<html lang="en">
<head>
<meta http-equiv="Cache-Control"
	content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Model Configuration</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script
	src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/bootstrap-slider.js"></script>
<script type="text/javascript"
	src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet"
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/css/bootstrap-slider.css" />
<script>
	var json = "";
	var edit = false;
	var i = 0;
	function getCookie(name) {
		var value = "; " + document.cookie;
		var parts = value.split("; " + name + "=");
		if (parts.length == 2)
			return parts.pop().split(";").shift();
	}
	if (getCookie("developer") != "Guilherme") {
		window.location.href = "http://localhost:20000/Diversity/pages/index.html";
	}

	ws = new WebSocket('ws://' + window.location.hostname + ":"
			+ window.location.port + '/Diversity/server');

	document.addEventListener('DOMContentLoaded', function() {
		$('#age').slider();
	}, false);

	ws.onopen = function() {
		if (getCookie("model") != null) {
			json = {
				"Op" : "get_model",
				"Model" : getCookie("model"),
			}
			ws.send(JSON.stringify(json));
		}
	}
	ws.onmessage = function(event) {
		var json = JSON.parse(event.data);
		console.log(json);

		if (json[0].Op == "Error") {
			alert(json[0].Message);
			if(json[0].hasOwnProperty('id')){
			document.cookie="model="+json[0].id;
			location.reload();			
			}
			return;
		}
		if(json[0].Op=="Model"){
		console.log(json[0]);
			
			document.getElementById("model_name").value=json[0].Name;
			document.getElementById("frequency").value=json[0].Update;
			document.getElementById("pss").value=json[0].PSS;
			document.getElementById("gender").value=json[0].Gender;
			document.getElementById("final").checked=json[0].Final_products;
			document.getElementById("Archive").checked=json[0].Archive==1;
			$("#age").data("slider-value")=json[0].Age;
			
			document.getElementById("fcheckbox").style.display = "block";
			document.getElementById("Archive").disabled = false;
			document.getElementById("submit").value = "Edit";
			edit = true;
		}
	}
	function escapeHtml(html)
	{
	    var text = document.createTextNode(html);
	    var div = document.createElement('div');
	    div.appendChild(text);
	    return div.innerHTML;
	}

	function addline() {
		var name = escapeHtml(document.getElementById("new_name").value);
		var value = escapeHtml(document.getElementById("new_URI").value);
		if (name == "" || value == "")
			return;
		value = value.replace("http://", "");
		value = "http://" + value;
		$('#left_menu').append(
				'<div class="checkbox"><label><input type="checkbox" value="'+value+'"">'
						+ name + '</label></div>');
		document.getElementById("new_name").value = "";
		document.getElementById("new_URI").value = "";
	}

	function send_config() {
		var configs = "";
		$('#left_menu').find('input[type=checkbox]').each(function() {
			if (this.checked == true) {
				configs += this.value + ";";
			}
		});
		var erro = false;
		var jsonData = {
			"Op" : "create_model",
			"URI" : configs != "" ? configs : erro = true,
			"Update" : document.getElementById('frequency').value != "" ? document
					.getElementById('frequency').value
					: erro = true,
			"PSS" : document.getElementById('pss').value != "" ? document
					.getElementById('pss').value : erro = true,
			"Age" : document.getElementById('age').value != "" ? document
					.getElementById('age').value : erro = true,
			"Gender" : document.getElementById('gender').value != "" ? document
					.getElementById('gender').value : erro = true,
			"Final_Product" : document.getElementById('final').checked,
			"Archive" : document.getElementById('Archive').checked,
			"Name" : document.getElementById('model_name').value != "" ? document
					.getElementById('model_name').value
					: erro = true,
			"User" : 1,//TODO find this field

		}
		if (erro == true) {
			alert("All Fields must be filled");
			return;
		}
		console.log(jsonData);
		ws.send(JSON.stringify(jsonData));

	}
	function checknumber(field) {
		field.value = field.value.replace(/[^0-9]/g, '');
		if (field.value > 99) {
			field.value = '99';
		} else if (field.value < 0) {
			field.value = '0';
		}

	}
</script>
<style>
input[type="number"] {
	width: 50px;
}

#global {
	position: relative;
	width: 80%;
	margin-left: 10%;
	height: 50vh;
}

#menu {
	position: relative;
	width: 80%;
	height: 80%;
	margin-top: 4%;
}

.inlineTable {
	display: inline-block;
	vertical-align: top;
	margin-left: "10%";
	margin-rigth: "10%";
}

.inlineTop {
	vertical-align: top;
}

.checkbox {
	vertical-align: top;
}

.left_menu {
	vertical-align: top;
}

#setup {
	position: absolute;
	bottom: 0;
}
</style>
</head>
<body>
	<center>
		<img src="../images/Diversity-Logo-120x62.png" alt="Diversity Logo"
			align="top">
	</center>
	<!-- BotÃµes opcionais -->
	<div id="global" align="center">
		<table id="menu">
			<tr>
				<td style="vertical-align: top">
					<div id="left_menu" class="inlineTop">
						<input type="text" id="new_name" placeholder="Name"><input
							type="text" id="new_URI" placeholder="URI">
						<button class="glyphicon glyphicon-plus" onclick="addline();"></button>
						<div class="checkbox">
							<label for="test"><input id="test" type="checkbox"
								value="http://www.google.pt">Google</label>
						</div>
						<div class="checkbox">
							<label><input type="checkbox"
								value="http://www.twitter.com">Twitter</label>
						</div>
						<div class="checkbox">
							<label><input type="checkbox"
								value="http://www.facebook.com">Facebook</label>
						</div>
					</div>
				</td>
				<td style="vertical-align: top">
					<table id="right_menu" class="inlineTable">
						<tr>
							<td><div class="form-group">
									<label for="model_name">Model Name:</label> <input type="text"
										class="form-control" id="model_name"> <label
										for="frequency">Update Frequency(Days):</label> <input
										type="number" class="form-control" id="frequency"
										style="width: 75px;" onKeyUp="checknumber(this)" min="0">
									<label for="pss">PSS:</label> <input type="text"
										class="form-control" id="pss">
								</div>
								<div id="fcheckbox" style="display: none;" class="checkbox">
									<label><input id="Archive" type="checkbox" value=""
										disabled>Archive</label>
								</div></td>
							<td></td>
						</tr>
						<tr>
							<td>

								<div class="form-group">
									<label for="age">Age Range:</label> <b>0 &nbsp</b> <input
										id="age" type="text" class="span2" value=""
										data-slider-min="0" data-slider-max="99" data-slider-step="1"
										data-slider-value="[5,99]" /> <b>&nbsp 99</b>
							</td>
						</tr>
						<tr>
							<td><label for="gender">Genders</label> <select id="gender">
									<option value="All" selected>All</option>
									<option value="Male">Male</option>
									<option value="Female">Female</option>
							</select>
								</div>
								<div class="checkbox">
									<label><input id="final" type="checkbox" value="">Include
										Final Products</label>
								</div></td>
							<td></td>
						</tr>
					</table>
				</td>
				<td></td>
			</tr>

		</table>
		<input id="submit" class="btn btn-default btn-block"
			onclick="send_config();" type="submit" value="Create" />
	</div>
	</div>
</body>