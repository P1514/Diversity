
<!DOCTYPE html>

<html lang="en">
<head>
<meta http-equiv="Cache-Control"
	content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Model Configuration</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
<script
	src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/bootstrap-slider.js"></script>
<script type="text/javascript"
	src="https://www.gstatic.com/charts/loader.js"></script>
<link rel="stylesheet"
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.2.0/css/bootstrap-slider.css" />
<script>
	var json = "";
	var edit = false;
	var i = 0;
	var id=0;
	var jsonData;
	function getCookie(name) { //not being used
		var value = "; " + document.cookie;
		var parts = value.split("; " + name + "=");
		if (parts.length == 2)
			return parts.pop().split(";").shift();
	}

	var ws;
	document.addEventListener('DOMContentLoaded', function() {
		$('#age').slider();
		ws = new WebSocket('ws://' + window.location.hostname + ":"
			+ window.location.port + '/Diversity/server');
			
			ws.onopen = function() {
	json = {
			"Op" : "getpss",
		}
		ws.send(JSON.stringify(json));
	}
	
	ws.onmessage = function(event) {
	console.log(event.data);
		var json = JSON.parse(event.data);
		if(json[0].Op=="Model"){
		var json2 = JSON.parse(event.data);}
		console.log(json);

		if (json[0].Op == "Error") {
			alert(json[0].Message);
			if(json[0].hasOwnProperty('id')){
			sessionStorage.Id="model="+json[0].id;
			location.reload();			
			}
			return;
		}
		if (json[0].Op == "pss") {
			jsonData = JSON.parse(JSON.stringify(json));
			populatePSS();
				if (sessionStorage.id != null) {
				var json2 = {
					"Op" : "get_model",
					"Id" : sessionStorage.id,
				}
				//console.log("YOYOYOYOLO -> " +JSON.stringify(json2));
				ws.send(JSON.stringify(json2));
				return;
				}
			}
		if(json2 != null && json2[0].Op=="Model"){
		console.log(json2[0]);
			
			document.getElementById("model_name").value=json2[0].Name;
			document.getElementById("model_name").readOnly = true;
			document.getElementById("frequency").value=json2[0].Update;
			document.getElementById('pss').value=json2[0].PSS;
			document.getElementById('pss').text=json2[0].PSS;
			document.getElementById("pss").disabled = true;
			//document.getElementById("gender").value=json2[0].Gender;
			document.getElementById("final").checked=json2[0].Final_products;
			//console.log(json2[0].Archive);
			//console.log(json2[0].Final_products);
			document.getElementById("Archive").checked=json2[0].Archive;
			//var ager=json2[0].Age.split(",").map(Number).filter(Boolean);// Converts string from DB to array of ints
			//$('#age').slider('setValue', ager);
			var uris = json2[0].URI.split(";");
			for(i=0; i<uris.length; i++){
			console.log("HELLO "+uris[i]+"\r\n");
			$(':checkbox[value="'+uris[i]+'"]').prop("checked","true");}
			
			document.getElementById("fcheckbox").style.display = "block";
			document.getElementById("Archive").disabled = false;
			document.getElementById("submit").value = "Update";
			edit = true;
		}
		}

	}, false);

	
	function populatePSS() {
		var products = JSON.parse(JSON.stringify(jsonData));
		for (var i = 1; i < products.length; i++) {
		console.log(products[i].Pss);
		$('#pss').append('<option value="'+products[i].Pss+'">'+products[i].Pss+'</option>');
		}
		
	}
	
	function escapeHtml(html)
	{
	    var text = document.createTextNode(html);
	    var div = document.createElement('div');
	    div.appendChild(text);
	    return div.innerHTML;
	}

	function addline() {
		var name = escapeHtml(document.getElementById("new_name").value);
		var value = escapeHtml(document.getElementById("new_URI").value);
		if (name == "" || value == "")
			return;
		$('#left_menu').append(
				'<div class="checkbox"><label><input type="checkbox" value="'+name+","+value+'"">'
						+ name + '</label></div>');
		document.getElementById("new_name").value = "";
		document.getElementById("new_URI").value = "";
	}

	function send_config() {
		var configs = "";
		$('#left_menu').find('input[type=checkbox]').each(function() {
			if (this.checked == true) {
				configs += this.value + ";";
			}
		});
		var erro = false;
		var jsonData = {
			"Op" : document.getElementById("submit").value.toLowerCase()+"_model",
			"URI" : configs != "" ? configs : erro = true,
			"Update" : document.getElementById('frequency').value != "" ? document
					.getElementById('frequency').value
					: erro = true,
			"PSS" : document.getElementById('pss').value != "" ? document
					.getElementById('pss').value : erro = true,
			/*"Age" : document.getElementById('age').value != "" ? document
					.getElementById('age').value : erro = true,
			"Gender" : document.getElementById('gender').value != "" ? document
					.getElementById('gender').value : erro = true,*/
			"Final_Product" : document.getElementById('final').checked,
			"Archive" : document.getElementById('Archive').checked,
			"Name" : document.getElementById('model_name').value != "" ? document
					.getElementById('model_name').value
					: erro = true,
			"User" : 1,//TODO find this field
			"Id":sessionStorage.id,

		};
		if (erro == true) {
			alert("All Fields must be filled");
			return;
		}
		console.log(jsonData);
		ws.send(JSON.stringify(jsonData));

	}
	function checknumber(field) {
		field.value = field.value.replace(/[^0-9]/g, '');
		if (field.value > 99) {
			field.value = '99';
		} else if (field.value < 0) {
			field.value = '0';
		}

	}
</script>
<style>
input[type="number"] {
	width: 50px;
}

#global {
	position: relative;
	width: 80%;
	margin-left: 10%;
	height: 50vh;
}

#menu {
	position: relative;
	width: 80%;
	height: 80%;
	margin-top: 4%;
}

.inlineTable {
	display: inline-block;
	vertical-align: top;
	margin-left: "10%";
	margin-rigth: "10%";
}

.inlineTop {
	vertical-align: top;
}

.checkbox {
	vertical-align: top;
}

.left_menu {
	vertical-align: top;
}

#setup {
	position: absolute;
	bottom: 0;
}
</style>
</head>
<body>
	<center>
		<img src="../images/Diversity-Logo-120x62.png" alt="Diversity Logo"
			align="top">
	</center>
	<!-- BotÃµes opcionais -->
	<div id="global" align="center">
		<table id="menu">
			<tr>
				<td style="vertical-align: top">
					<div id="left_menu" class="inlineTable">
						<div class="form-group">
							<select class="form-control" id="new_name">
								<option value="Facebook">Facebook</option>
								<option value="Twitter">Twitter</option>
							</select>
						</div>
						<input class="form-control" type="text" id="new_URI" placeholder="Account">
						<button class="glyphicon glyphicon-plus" onclick="addline();"></button>

					</div>
				</td>
				<td style="vertical-align: top">
					<table id="right_menu" class="inlineTable">
						<tr>
							<td><div class="form-group">
									<label for="model_name">Model Name:</label> <input type="text"
										class="form-control" id="model_name"> <label
										for="frequency">Update Frequency(Days):</label> <input
										type="number" class="form-control" id="frequency"
										style="width: 75px;" onKeyUp="checknumber(this)" min="0">
									<div class="form-group">
										<label for="pss">PSS:</label> <select class="form-control"
											id="pss"></select>
									</div>
								</div>
								<div id="fcheckbox" style="display: none;" class="checkbox">
									<label><input id="Archive" type="checkbox" value=""
										disabled>Archive</label>
								</div></td>
							<td></td>
						</tr>
						<tr>
							<td>
								<!--<div class="form-group">
									<label for="age">Age Range:</label> <b>0 &nbsp</b> <input
										id="age" type="text" class="span2" value=""
										data-slider-min="0" data-slider-max="99" data-slider-handle="round" data-slider-size="100px" data-slider-step="1"
										data-slider-value="[5,99]" /> <b>&nbsp 99</b>
							</td>
						</tr>
						<tr>
							<td><label for="gender">Genders</label> <select id="gender">
									<option value="All" selected>All</option>
									<option value="Male">Male</option>
									<option value="Female">Female</option>
							</select>
								</div>-->
								<div class="checkbox">
									<label><input id="final" type="checkbox" value=""
										checked>Include Final Products</label>
								</div>
							</td>
							<td></td>
						</tr>
					</table>
				</td>
				<td></td>
			</tr>

		</table>
		<input id="submit" class="btn btn-default btn-block"
			onclick="send_config();" type="submit" value="Create" />
	</div>
</body>