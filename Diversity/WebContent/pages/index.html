<!DOCTYPE html>
<html lang='en'>
<head>
<meta http-equiv='Cache-Control'
	content='no-cache, no-store, must-revalidate' />
<meta http-equiv='Pragma' content='no-cache' />
<meta http-equiv='Expires' content='0' />
<title>Sentiment Home Page</title>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet'
	href='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
<script
	src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js'></script>
<script
	src='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>
<script type='text/javascript'
	src='https://www.gstatic.com/charts/loader.js'></script>
<script>
	google.charts.load('current', {packages:['corechart']});
	ws = new WebSocket('ws://' + window.location.hostname + ':'
			+ window.location.port + '/Diversity/server');
	var json;
	var i = 0;
	var middle;
	var jsonData;
	var newData;

	function getCookie(name) {
		var value = '; ' + document.cookie;
		var parts = value.split('; ' + name + '=');
		if (parts.length == 2)
			return parts.pop().split(';').shift();
	}

	function setCookie() {
		// document.cookie='Product=; expires=Thu, 01-Jan-1970 00:00:01 GMT;';
	//	document.cookie = 'Model='
				+ $('#Models :selected').text();
				var cookiemonster = document.getElementById('Models').value.split(';');
		//document.cookie = 'Id=' + cookiemonster[0];
		//document.cookie = 'PSS=' + cookiemonster[1];
		sessionStorage.model=$('#Models :selected').text();
		sessionStorage.id=cookiemonster[0];
		sessionStorage.pss=cookiemonster[1];
	}

	ws.onopen = function() {
		var jsonData = {
			'Op' : 'getmodels',
		}
		ws.send(JSON.stringify(jsonData));
	}
	ws.onmessage = function(event) {
		json = JSON.parse(event.data);
		if (json[0].Op == 'Error') {
			alert(json[0].Message);
		}
		if (json[0].Op == 'Models') {
			populatePSS();
			var jsonData = {
				'Op' : 'Top5Reach',
			}
			ws.send(JSON.stringify(jsonData));
		}
		if (json[0].Op == 'Graph') {
			newData = JSON.parse(JSON.stringify(json));
			//drawChart();
			if (!json[1].hasOwnProperty('Graph')) {
				google.charts.setOnLoadCallback(drawChart);
			} else if (json[1].Graph == "ERROR") {
					console.log("No data to display.")
				}
			}

		}
	}

	function new_model(){

	sessionStorage.clear();

	}

	function populatePSS() {
		var x = document.getElementById('Models');
		var Models = JSON.parse(JSON.stringify(json));
		for (var i = 1; i < Models.length; i++) {
			var option = document.createElement('option');
			option.text = Models[i].Name;
			option.value = Models[i].Id+';'+Models[i].PSS;
			if(getCookie('Product') == option.text)
				option.selected=true;
			x.add(option);
		}
		checkEditable();
		console.log($('#Models option').size());
	}


	function checkEditable() {
		if ($('#Models option').size() == 0) {
			document.getElementById('edit_model').disabled = true;
		} else {
			document.getElementById('edit_model').disabled = false;
		}
	}

	$(window).resize(function() {
		if (this.resizeTO)
			clearTimeout(this.resizeTO);
		this.resizeTO = setTimeout(function() {
			$(this).trigger('resizeEnd');
		}, 500);
	});

	//redraw graph when window resize is completed
	$(window).on('resizeEnd', function() {
		if (newData != 0) {
			drawChart();
		}
	});


	function refreshDB(clean) {
		if (clean == 1) {
			json = {
				'Op' : 'clean',
			}

			ws.send(JSON.stringify(json));
			setTimeout(function(){json = {
					'Op' : 'load',
				}

				ws.send(JSON.stringify(json));}, 3000);
		}else{
		setTimeout(function(){json = {
			'Op' : 'load',
		}

		ws.send(JSON.stringify(json));}, 0);
		}
	};

	function drawChart() {
		//top 5 PSS
		middle = new google.visualization.LineChart(document.getElementById('top5'));

		var data = JSON.parse(JSON.stringify(newData));


		var globaldata = new google.visualization.DataTable();
		globaldata.addColumn('string', 'Month');

		var counter = data[1];

		var pssNumber = 0;
		for (var i = 0; i < counter.length; i++) {							// find the number of PSSs to display (amount of 'Filter' in JSON)
			if (counter[i].hasOwnProperty('Filter')) {
				globaldata.addColumn('number', counter[i].Filter);
				pssNumber++;
			}
		}

		for (var i = 0; i < pssNumber + 1 ; i++) {							// until we reach the last PSS...
			if (!counter[i].hasOwnProperty('Filter')) {						// if its a month,value pair
				for (var j = 0; j < 12; j++) {											// for each month
					if (i == 1 && j == 0) {
						globaldata.addRows(12);													// add 12 rows for the 12 months
					}
					globaldata.setCell(j,0,counter[((i-1)*12) + i+j].Month);				// the first cell of each line is the name of the month
					globaldata.setCell(j,i,counter[((i-1)*12) + i+j].Value); // set the value of the cell
				}															// if it's the first iteration, the array position is i+j. for the other iterations it
			}																// adds 12 positions per iteration
		}

	 var options = {
		 title: 'Top ' + pssNumber + ' PSS Global Sentiment',
		 lineWidth: 3,
		 legend : {
			 position : 'bottom'
		 },
		 hAxis: {
			 showTextEvery: 1,
			 textStyle : {
				 fontSize: 12
			 }
		 },
		 vAxis: {
			 title: 'Global Sentiment',
			 viewWindow: {
			 	max: 0,
			 	min: 100
			}
		},
		width : '100%',
		height : '100%'
	 };

	 middle.draw(globaldata, options);
	}
</script>
<style>
#pss {
	margin-top: 150px;
}

#buttons {
	margin-top: 50px;
}

#opinion {
	display: inline-block;
}

#global {
	display: inline-block;
	margin-left: 100px;
}

#refresh {
	display: inline-block;
	margin-left: 100px;
}

#top5 {
	width: 100%;
	height: 100%
}

</style>
</head>
<body>
	<center>
		<img src='../images/Diversity-Logo-120x62.png' alt='Diversity Logo'
			align='top'>

		<!--Lista de PSS-->
		<div id='pss'>
			<label>Choose Model:</label> <select id='Models'>
			</select><form action='models.html'>
					<input id='create_model' class='btn btn-default' onclick='new_model();'
						type='submit' value='Create Model' />
					<input id='edit_model' class='btn btn-default' onclick='setCookie();'
						type='submit' value='Edit Model' />
				</form>
		</div>

		<!--Top5 PSS Global Sentiment-->
		<div id='top5'></div>

		<!-- BotÃµes opcionais -->
		<table></table>
		<table id='buttons'>
		<td>
				<form action='chart_setup.html'>
					<input id='setup' class='btn btn-default' onclick=''
						type='submit' value='Chart Setup' />
				</form>
			</td>
			<td>
				<form action='opinion_extraction_page.html'>
					<input id='global' class='btn btn-default' onclick='setCookie();'
						type='submit' value='Get Opinion Extraction' />
				</form>
			</td>
			<!--<td>
				<form action='opinion_extraction_page.html'>
					<input id='global' class='btn btn-default' onclick='setCookie();'
						type='submit' value='Get Opinion' />
				</form>
			</td>
			<td>
				<form action='global_sentiment_page.html'>
					<input id='global' class='btn btn-default' onclick='setCookie();'
						type='submit' value='Get Global Sentiment' />
				</form>
			</td>-->
			<td>
				<form>
					<input id='refresh' class='btn btn-default' type=button
						value='Refresh' onClick='refreshDB(1)'>
				</form>
			</td>
		</table>
	</center>
</body>
