<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta http-equiv="Cache-Control"
	content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>Opinion Extraction</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
	<link rel="stylesheet"
		href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
		<script
			src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<script
			src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script type="text/javascript"
			src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="sorttable.js"></script>
		<script type="text/javascript">
			var json;
			var jsonData;
			var ws;

			//create trigger to resizeEnd event     
			$(window).resize(function() {
				if (this.resizeTO)
					clearTimeout(this.resizeTO);
				this.resizeTO = setTimeout(function() {
					$(this).trigger('resizeEnd');
				}, 500);
			});

			//redraw graph when window resize is completed  
			$(window).on('resizeEnd', function() {
				if (jsonData != 0)
				drawChart();
			});
			function connect() {
				document.getElementById("Cookie").innerHTML = "Model: "
						+ window.sessionStorage.model + "; PSS: "
						+ window.sessionStorage.pss;

				ws = new WebSocket('ws://' + window.location.hostname + ":"
						+ window.location.port + '/Diversity/server');

				ws.onopen = function() {
				
				json = {
						"Op" : "getposts",
						"Id" : sessionStorage.id
					}

					ws.send(JSON.stringify(json));
				};

				ws.onmessage = function(event) {
					json = JSON.parse(event.data);

					if (json[0].Op == "Error") {
						alert(json[0].Message);
						return;
					}
					if (json[0].Op == "OE_Redone") {
						jsonData = JSON.parse(JSON.stringify(json));
						drawChart();
						return;
					}

					if (json[0].Op == "table") {
						//populate table
						var tr;
						$('#posts tbody').empty();
						for (var i = 1; i < json.length; i++) {
							tr = $('<tr/>');
							tr.append("<td>" + json[i].Name + "</td>");
							tr.append("<td>" + json[i].Message + "</td>");
							tr.append("<td>" + json[i].Comments + "</td>");
							tr.append("<td>" + json[i].Date + "</td>");
							tr.append("<td>" + json[i].Polarity + "</td>");
							tr.append("<td>" + json[i].Reach + "</td>");
							tr.append("<td>" + json[i].Influence + "</td>");
							tr.append("<td>" + json[i].Location + "</td>");
							tr.append("<td>" + json[i].Gender + "</td>");
							tr.append("<td>" + json[i].Age + "</td>");
							tr
									.append("<td><input type=\"hidden\" name=\"id\" value=\"" + json[i].Id +"\">");
							$('#posts tbody').append(tr);
						}
						$('.table > tbody > tr').click(function(e) {
							clicker($(this).find('input[name="id"]').val());
						});
						json = {
						"Op" : "testing",
						"Id" : window.sessionStorage.id
					}

					ws.send(JSON.stringify(json));
						return;
					}
					if (json[0].Op == "graph") {
						jsonData = JSON.parse(JSON.stringify(json));
						drawChart();
						return;
					}
					if (json[0].Op == "comments") {
						clicker();
						return;
					}
				};
			}

			google.charts.load('current', {
				packages : [ 'corechart', 'bar', 'gauge' ]
			});
			google.charts.setOnLoadCallback(connect);
			// Detect table click

			function clicker(hidden) {
				var thediv = document.getElementById('displaybox');
				var embedCode = '<iframe width="75%" height="45%" src="comments.html?id='
						+ hidden
						+ ' frameborder="0" allowfullscreen="no"></iframe>';
				if (thediv.style.display == "none") {
					thediv.style.display = "";
					thediv.innerHTML = "<table width='100%' height='100%'><tr><td align='center' valign='bottom' width='80%' height='80%'>"
							+ "<param name='bgcolor' value='#000000'>"
							+ embedCode
							+ "</tr><tr align='center' valign='top' width='10%' height='10%'><td><a href='#' align='center' onclick='return clicker();'>CLOSE WINDOW</a></td></tr></table>";
					//thediv.innerHTML = ""++ "<button onclick='clicker()' id='closepage' class='btn btn-default'>Close Page</button>";
				} else {
					thediv.style.display = "none";
					thediv.innerHTML = '';
				}
				return false;
			}

			function drawChart() {
				// Top Left
				var data = new google.visualization.DataTable();
				var i=1;
				data.addColumn('string', 'Gender')
				data.addColumn('number', 'Global')
				for(ii = 0;jsonData[i].Graph=="Top_Left"; ii++, i++){
					data.addRow();
					data.setCell(ii, 0, jsonData[i].Param);
					data.setCell(ii,1, jsonData[i].Value)
				}

				var options = {
					title : 'Total Opinions',
					pieSliceTextStyle: {fontSize : 18},
					pieSliceText: 'value',
					legend: {position: 'none'},
					enableInteractivity : false,
				};

				var chart = new google.visualization.PieChart(document
						.getElementById('opinionpie'));

				chart.draw(data, options);

				// Top Middle

				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Polarity')
				data.addColumn('number', 'Global')
				for(ii = 0;jsonData[i].Graph=="Top_Middle"; ii++, i++){
					data.addRow();
					data.setCell(ii, 0, jsonData[i].Param);
					data.setCell(ii,1, jsonData[i].Value);
				}
				var options = {
					title : 'Polarity',
					colors : [ '#9575cd', '#33ac71' ],
					vAxis : {
						title : 'no. posts',
						gridlines: {
							count: 6,
						}
					},
					hAxis : {
					
					baselineColor : 'transparent',
						gridlines: {
							color: 'transparent'
					}
					},
					legend: { position: 'bottom' }
				};

				var chart = new google.visualization.ColumnChart(document
						.getElementById('polaritybar'));
				chart.draw(data, options);
				
				// Top Right

				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Polarity')
				data.addRow();
				data.setCell(0, 0, "Sentiment");
				for(ii = 0;jsonData[i].Graph=="Top_Right"; ii++, i++){
					data.addColumn('number', 'Global')
					data.setCell(0,1, jsonData[i].Value);
				}

				var options = {
					width : 600,
					height : 200,	
					max : 1,
					min : -1,
					redFrom : -1,
					redTo : -0.5,
					yellowFrom : -0.5,
					yellowTo : 0,
					minorTicks : 5
				};

				var chart = new google.visualization.Gauge(document
						.getElementById('globalgauge'));

				chart.draw(data, options);
				
				//Bottom Left

				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Gender');
				data.addColumn('number', 'Value');
				for(ii = 0;jsonData[i].Graph=="Bottom_Left"; ii++, i++){
					data.addRow();
					data.setCell(ii, 0, jsonData[i].Param);
					data.setCell(ii,1, jsonData[i].Value)
				}

				var options = {
					title : 'Average Reach',
					pieSliceTextStyle: {fontSize : 18},
					pieSliceText: 'value',
					legend: {position: 'none'},
					enableInteractivity : false,
				};

				var chart = new google.visualization.PieChart(document
						.getElementById('reachpie'));
				chart.draw(data, options);

				//Bottom Middle
				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Month');
				data.addColumn('number', 'Reach');
				
				for(ii = 0;i<jsonData.length && jsonData[i].Graph=='Bottom_Middle'; ii++, i++){
					data.addRow();
					data.setCell(ii, 0, jsonData[i].Param);
					data.setCell(ii,1, jsonData[i].Value)
				}

				var options = {
					hAxis : {
						title : 'Time'
					},
					vAxis : {
						title : 'Reach'
					}
				};

				var chart = new google.visualization.LineChart(document
						.getElementById('reachline'));

				chart.draw(data, options);
				
				//Bottom Right
				var data = new google.visualization.DataTable();
				data.addColumn('string', 'Month');
				data.addColumn('number', 'Sentiment');
				console.log(jsonData[i]);
				console.log(i);

				for(ii = 0;i<jsonData.length && jsonData[i].Graph=='Bottom_Right'; ii++, i++){
					data.addRow();
					data.setCell(ii, 0, jsonData[i].Month);
					data.setCell(ii,1, jsonData[i].Sentiment)
				}

				var options = {
					hAxis : {
						title : 'Time'
					},
					vAxis : {
						title : 'Popularity'
					}
				};

				var chart = new google.visualization.LineChart(document
						.getElementById('globalline'));

				chart.draw(data, options);
				google.visualization.events.addListener(chart, 'select', function() {
				var selection = chart.getSelection();
				if (selection != "") {
					var row = selection[0].row;
					var col = selection[0].column;
					var month = data.getValue(row,0);

					json = {
						"Op" : "getposts",
						"Id" : sessionStorage.id,
						"Param" : "Month",
						"Values" : month,
					}
					console.log(json);

					ws.send(JSON.stringify(json));
	
				} else {
					json = {
						"Op" : "getposts",
						"Pss" : sessionStorage.pss
					}

					ws.send(JSON.stringify(json));
				}
				})

			}

			function chartcolor(data) {
				switch (data) {
				case "Global":
					return "#604460";
				case "Male":
					return "#00617F";
				case "Female":
					return "#0093C8";
				case "Asia":
					return "#FF3C14";
				case "Europe":
					return "#A60202";
				case "0-30":
					return "#BFD730";
				case "31-60":
					return "#8CA122";
				case "61-90":
					return "#5C6EoE";
				}
			}

			function changeRequest() {

				var json = {
					"Op" : "chartrequest",
					"Param" : "",
					"Values" : "",
					"Id" : getCookie("Id")
				};
			}
		</script>
		<style>
#displaybox {
	z-index: 10000;
	filter: alpha(opacity = 90); /*older IE*/
	filter: progid:DXImageTransform.Microsoft.Alpha(opacity=90); /* IE */
	-moz-opacity: .9; /*older Mozilla*/
	-khtml-opacity: 0.9; /*older Safari*/
	opacity: 0.9; /*supported by current Mozilla, Safari, and Opera*/
	background-color: #000000;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	text-align: center;
	vertical-align: bottom;
}

table.sortable th:not (.sorttable_sorted ):not (.sorttable_sorted_reverse
	 ):not (.sorttable_nosort ):after {
	content: " \25B4\25BE"
}

#dashboard {
	position: relative;
	width: 80%;
}

#home {
	position: absolute;
	right: 10px;
	top: 20px;
}

product {
	display: block;
	font-size: 20px;
	margin-top: 0.83em;
	margin-bottom: 0.83em;
	margin-left: 0;
	margin-right: 0;
	font-weight: normal;
}

.inlineTable {
	display: inline-block;
	vertical-align: top;
	text-align: center;
}

table {
	width: 100%;
}

.chart{
	display: inline-block;
}
</style>
</head>
<body>
	<!-- POPUP -->
	<div id="displaybox" style="display: none;"></div>
	<!-- Logotipo -->

	<center> <img src="../images/Diversity-Logo-120x62.png"
		alt="Diversity Logo" align="top"></img> </center>


	<!-- Gráfico + filtros-->
	<div class="container" id="dashboard">
		<product>
		<div id="Cookie">Error no product to display</div>
		</product>
		<button onclick="location.href = 'index.html';" id="home"
			class="btn btn-default">Home</button>
		<hr>
			<center>
			<table id="global">
				<tr>
					<td style="vertical-align: top">
						<table id="left" class="inlineTable">
							<tr>
								<td>
									<div id="opinionpie" class="chart"></div>
								</td>
							</tr>
							<tr>
								<td>
									<div id="reachpie" class="chart"></div>
								</td>
							</tr>
						</table>
					</td>

					<td style="vertical-align: center">
						<table id="middle" class="inlineTable">
							<tr>
								<td>
									<div id="polaritybar" class="chart"></div>
								</td>
							</tr>
							<tr>
								<td>
									<div id="reachline" class="chart"></div>
								</td>
							</tr>

						</table>
					</td>
					<td style="vertical-align: center">
						<table id="right" class="inlineTable">
							<tr>
								<td>
									<div id="globalgauge" class="chart"></div>
								</td>
							</tr>
							<tr>
								<td>
									<div id="globalline" class="chart"></div>
								</td>
							</tr>

						</table>
					</td>
				</tr>
			</table>

			</center>
	</div>

	<!-- Tabela Posts-->
	<div class="container" id="dashboard">
		<h2>Top 5</h2>
		<hr>
			<table id="posts" class="table sortable">
				<thead>
					<tr>
						<th>Original Author</th>
						<th>Post</th>
						<th># Comments</th>
						<th>Date</th>
						<th>Polarity</th>
						<th>Reach</th>
						<th>Influence</th>
						<th>Location</th>
						<th>Gender</th>
						<th>Age</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
	</div>
</body>
</html>